<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./js/supabase-config.js"></script>
<script>
    // ✅ NEW: Get orderId from URL
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId');
    
    async function verifyPayment() {
        try {
            if (!orderId) {
                throw new Error('Order ID not found');
            }
            
            // ✅ NEW: Call check-payment-status function
            const response = await fetch(`${SUPABASE_URL}/functions/v1/check-payment-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                },
                body: JSON.stringify({ merchantOrderId: orderId })
            });
            
            const result = await response.json();
            console.log('✅ Verification result:', result);

            if (result.success) {
                // ✅ Check payment status
                const isSuccess = 
                    result.phonepeState === 'COMPLETED' || 
                    result.paymentStatus === 'success';
                
                // ✅ Clear cart on success
                if (isSuccess) {
                    localStorage.removeItem('aazhi_cart');
                    localStorage.removeItem('pending_order_id');
                    console.log('✅ Cart cleared');
                }
                
                showStatus(
                    isSuccess ? 'success' : 'failed',
                    isSuccess ? 'Payment Successful!' : 'Payment Failed',
                    isSuccess 
                        ? `Your order #${result.order?.order_number || orderId} has been confirmed. You will receive a confirmation email shortly.`
                        : 'Your payment could not be processed. Please try again or contact support.',
                    result.order?.order_number
                );
            } else {
                throw new Error('Verification failed');
            }
            
        } catch (error) {
            console.error('❌ Verification error:', error);
            showStatus('failed', 'Verification Failed', 'Unable to verify payment status. Please contact support with your order ID: ' + orderId, null);
        }
    }
    
    function showStatus(type, title, message, orderNum) {
        const statusIcon = document.getElementById('statusIcon');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');
        const orderNumber = document.getElementById('orderNumber');
        const homeBtn = document.getElementById('homeBtn');
        
        statusIcon.className = `status-icon ${type}`;
        statusIcon.innerHTML = type === 'success' 
            ? '<i class="fa-solid fa-check-circle"></i>'
            : '<i class="fa-solid fa-times-circle"></i>';
        
        statusTitle.textContent = title;
        statusMessage.textContent = message;
        
        if (orderNum) {
            orderNumber.textContent = `Order Number: ${orderNum}`;
            orderNumber.style.display = 'block';
        }
        
        homeBtn.style.display = 'inline-flex';
    }
    
    // Verify payment on page load
    verifyPayment();
</script>